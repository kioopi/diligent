#!/usr/bin/env lua
--[[
Diligent CLI - Project Workspace Manager for AwesomeWM

Usage: workon <command> [options]

Commands:
  ping      Test communication with AwesomeWM
  help      Show this help message
--]]
--

-- Use D-Bus communication instead of shell-based awesome-client
local dbus = require("dbus_communication")

local args = {...}
local command = args[1] or "help"

-- Helper function to print colored output
local function print_success(msg)
  print("\027[32m✓\027[0m " .. msg)
end

local function print_error(msg)
  print("\027[31m✗\027[0m " .. msg)
end

local function print_info(msg)
  print("\027[34mℹ\027[0m " .. msg)
end

-- Command handlers
local commands = {}

function commands.help()
  print("Diligent v0.1.0 - Project Workspace Manager for AwesomeWM")
  print("")
  print("Usage: workon <command> [options]")
  print("")
  print("Commands:")
  print("  ping      Test communication with AwesomeWM")
  print("  help      Show this help message")
  print("")
  print("Examples:")
  print("  workon ping           # Test if AwesomeWM is responsive")
end

function commands.ping()
  -- First check if AwesomeWM is available via D-Bus
  local awesome_success, result = pcall(dbus.check_awesome_available)
  local available = awesome_success and result

  if not awesome_success then
    print_error("Error checking AwesomeWM availability: " .. tostring(result))
    os.exit(1)
  end

  if not available then
    print_error("AwesomeWM not available via D-Bus")
    print("  • Make sure AwesomeWM is running")
    print("  • Check that D-Bus session bus is available")
    print("  • Verify AwesomeWM has D-Bus support enabled")
    os.exit(1)
  end

  -- Send ping command and wait for response
  local payload = {
    timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ"),
    source = "diligent-cli"
  }

  local success, response = dbus.send_ping(payload)

  if not success then
    print_error("Failed to get response: " .. response)
    print("")
    print("Troubleshooting:")
    print("  • Ensure the Diligent module is loaded in your AwesomeWM rc.lua:")
    print("    local diligent = require('diligent')")
    print("    diligent.setup()")
    print("  • Check that the lua/ directory is in your Lua path")
    os.exit(1)
  end

  print_success("Ping successful!")
  print_info("Response: " .. response)

  -- Check if response is valid JSON
  local parse_success, error = dbus.parse_response(response)
  if not parse_success then
    print_error("Could not JSON parse response " .. tostring(error))
  end
end

-- Main execution
if commands[command] then
  local status, err = pcall(commands[command])
  if not status then
    print_error("Command failed: " .. err)
    os.exit(1)
  end
else
  print_error("Unknown command: " .. command)
  print("")
  commands.help()
  os.exit(1)
end
